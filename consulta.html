// =======================================================================================
// SIREX ¬∑ Consulta Global / Res√∫menes v2.5
// Autor: Gemini (Asistente de Programaci√≥n)
// Descripci√≥n: L√≥gica completa y mejorada para la consulta, visualizaci√≥n profesional
//              y exportaci√≥n multi-formato de res√∫menes operativos desde Firebase.
// MEJORAS CLAVE:
// 1. **Datos del Puerto Enriquecidos**: La consulta ahora obtiene y muestra todos los
//    campos num√©ricos disponibles para el Grupo Puerto, presentados en columnas.
// 2. **Exportaci√≥n a PDF Profesional**: El PDF ha sido redise√±ado por completo. Ahora
//    incluye todos los grupos, texto narrativo y tablas con un dise√±o profesional
//    y estilizado, convirti√©ndolo en un informe completo y pulcro.
// 3. **Visualizaci√≥n CECOREX**: Se confirma y refina la presentaci√≥n en tres
//    columnas para los datos de CECOREX, optimizando la legibilidad.
// =======================================================================================

document.addEventListener('DOMContentLoaded', () => {

    // --- 1. CONFIGURACI√ìN CENTRAL DE LA APLICACI√ìN ---
    const AppConfig = {
        firebase: {
            apiKey: "AIzaSyDTvriR7KjlAINO44xhDDvIDlc4T_4nilo",
            authDomain: "ucrif-5bb75.firebaseapp.com",
            projectId: "ucrif-5bb75",
            storageBucket: "ucrif-5bb75.appspot.com",
            messagingSenderId: "241698436443",
            appId: "1:241698436443:web:1f333b3ae3f813b755167e"
        },
        grupos: {
            ucrif: { label: 'UCRIF (Grupos 2, 3 y 4)', icon: 'üõ°Ô∏è', color: '#0dcaf0', theme: 'info' },
            grupo1: { label: 'Grupo I - Expulsiones', icon: '‚úàÔ∏è', color: '#0d6efd', theme: 'primary' },
            puerto: { label: 'Grupo Puerto', icon: '‚öì', color: '#198754', theme: 'success' },
            cecorex: { label: 'CECOREX', icon: 'üì°', color: '#ffc107', theme: 'warning' },
            gestion: { label: 'Grupo de Gesti√≥n', icon: 'üìã', color: '#6c757d', theme: 'secondary' },
            cie: { label: 'CIE', icon: 'üè¢', color: '#dc3545', theme: 'danger' }
        },
        frasesNarrativas: {
            apertura: [
                "Desplegadas actuaciones operativas clave, se ha reforzado la vigilancia y el control en materia de extranjer√≠a en el periodo analizado.",
                "En el marco de las competencias de la Brigada, se han desarrollado dispositivos coordinados para la prevenci√≥n y actuaci√≥n frente a la inmigraci√≥n irregular.",
                "La intervenci√≥n en focos de riesgo se ha consolidado con resultados notables, destacando las siguientes actuaciones coordinadas.",
            ],
            cierre: [
                "El conjunto de actuaciones llevadas a cabo refuerza la seguridad ciudadana y consolida la estrategia de la Brigada.",
                "El servicio se cierra sin incidencias extraordinarias que rese√±ar, cumpliendo con los objetivos marcados.",
                "Parte cerrado con un balance de actividad positivo para la operativa global de la UCRIF."
            ]
        }
    };

    // --- 2. INICIALIZACI√ìN DE FIREBASE ---
    if (!firebase.apps.length) {
        firebase.initializeApp(AppConfig.firebase);
    }
    const db = firebase.firestore();
    const FieldPath = firebase.firestore.FieldPath;

    // --- 3. REFERENCIAS A ELEMENTOS DEL DOM ---
    const DOM = {
        form: document.getElementById('consultaForm'),
        spinner: document.getElementById('spinner'),
        resumenVentana: document.getElementById('resumenVentana'),
        exportBtns: document.getElementById('exportBtns'),
        btnWhatsapp: document.getElementById('btnWhatsapp'),
        btnExportarPDF: document.getElementById('btnExportarPDF'),
        fechaDesde: document.getElementById('fechaDesde'),
        fechaHasta: document.getElementById('fechaHasta'),
    };

    // --- 4. ESTADO GLOBAL DE LA APLICACI√ìN ---
    let appState = {
        ultimoResumen: null,
        desde: '',
        hasta: ''
    };
    
    // --- 5. L√ìGICA DE CONSULTAS A FIRESTORE (QueryManager) ---
    const QueryManager = {
        getUcrifNovedades: async (desde, hasta) => {
            const collections = ['grupo2_registros', 'grupo3_registros', 'grupo4_operativo'];
            let rawData = [];
            for (const coll of collections) {
                const snap = await db.collection(coll).where(FieldPath.documentId(), '>=', desde).where(FieldPath.documentId(), '<=', hasta).get();
                snap.forEach(doc => rawData.push(doc.data()));
            }

            const resultado = {
                detenidosILE: 0, filiadosVarios: 0, traslados: 0, citadosCecorex: 0,
                inspecciones: [], detenidosDelito: [], observaciones: [],
                colaboraciones: [], dispositivos: []
            };

            const isILE = (motivo = '') => motivo.toUpperCase().includes('ILE') || motivo.toUpperCase().includes('EXTRANJER√çA');

            rawData.forEach(data => {
                resultado.filiadosVarios += Number(data.identificados_g4) || 0; //
                resultado.citadosCecorex += Number(data.citadosCecorex_g4) || 0; //
                if (data.traslados_g4) resultado.traslados += data.traslados_g4.length || 0; //
                if (data.colaboraciones_g4) resultado.colaboraciones.push(...data.colaboraciones_g4); //
                if (data.observaciones_g4) resultado.observaciones.push(data.observaciones_g4); //

                const todosDetenidos = [...(data.detenidos || []), ...(data.detenidos_g4 || [])]; //
                todosDetenidos.forEach(d => {
                    const motivo = d.motivo || d.motivo_g4 || ''; //
                    if (isILE(motivo)) {
                        resultado.detenidosILE++;
                    } else {
                        resultado.detenidosDelito.push({
                            descripcion: `${d.detenido || d.detenidos_g4 || 'N/A'} (${d.nacionalidad || d.nacionalidad_g4 || 'N/A'})`,
                            motivo: motivo,
                        });
                    }
                });
                
                if (data.inspecciones) resultado.inspecciones.push(...data.inspecciones); //
                if (data.actuaciones) resultado.dispositivos.push(...data.actuaciones); //
            });
            return resultado;
        },

        getGrupo1Detalles: async (desde, hasta) => {
            const snap = await db.collection('grupo1_expulsiones').where(FieldPath.documentId(), '>=', desde).where(FieldPath.documentId(), '<=', hasta).get(); //
            const res = { detenidos: [], expulsados: [], frustradas: [], fletados: [] };
            snap.forEach(doc => {
                const data = doc.data();
                if (data.detenidos_g1) res.detenidos.push(...data.detenidos_g1); //
                if (data.expulsados_g1) res.expulsados.push(...data.expulsados_g1); //
                if (data.exp_frustradas_g1) res.frustradas.push(...data.exp_frustradas_g1); //
                if (data.fletados_g1) res.fletados.push(...data.fletados_g1); //
            });
            return res;
        },
        
        getPuertoDetalles: async (desde, hasta) => {
            const snap = await db.collection('grupoPuerto_registros').where(FieldPath.documentId(), '>=', desde).where(FieldPath.documentId(), '<=', hasta).get(); //
            // Agregar√° todos los campos num√©ricos y las listas
            let res = {
                numericos: {},
                ferrys: [],
                gestiones: []
            };
            
            snap.forEach(doc => {
                const data = doc.data();
                // Suma campos num√©ricos
                for (const key in data) {
                    if (typeof data[key] === 'number' && key !== 'fecha') {
                        res.numericos[key] = (res.numericos[key] || 0) + data[key];
                    }
                }
                // Agrega elementos a las listas
                if (data.ferrys && Array.isArray(data.ferrys)) res.ferrys.push(...data.ferrys); //
                if (data.gestiones_puerto && Array.isArray(data.gestiones_puerto)) res.gestiones.push(...data.gestiones_puerto); //
            });
            return res;
        },

        sumarCampos: async (collection, desde, hasta) => {
            const snap = await db.collection(collection).where(FieldPath.documentId(), '>=', desde).where(FieldPath.documentId(), '<=', hasta).get();
            let res = {};
            snap.forEach(doc => {
                const data = doc.data();
                Object.keys(data).forEach(key => {
                    if (key !== 'fecha' && !isNaN(Number(data[key]))) {
                         res[key] = (res[key] || 0) + (Number(data[key]) || 0);
                    }
                });
            });
            return res;
        },

        getCIE: async function(desde, hasta) {
            const rangeTotals = await this.sumarCampos('cie_registros', desde, hasta); //
            const snapLastDay = await db.collection('cie_registros').where(FieldPath.documentId(), '<=', hasta).orderBy(FieldPath.documentId(), 'desc').limit(1).get(); //
            const finalCount = snapLastDay.empty ? "N/D" : (snapLastDay.docs[0].data().n_internos || 0); //
            return { ...rangeTotals, "Internos (a fin de periodo)": finalCount };
        }
    };

    // --- 6. L√ìGICA DE RENDERIZADO HTML (UIRenderer) ---
    const UIRenderer = {
        renderizarResumenGlobalHTML(resumen, desde, hasta) {
            let html = `<div class="alert alert-light text-center my-4 p-3 border rounded-3">
                            <h2 class="h4 mb-1"><b>RESUMEN OPERATIVO GLOBAL SIREX</b></h2>
                            <span class="text-muted">Periodo consultado: <b>${this.formatoFecha(desde)}</b> al <b>${this.formatoFecha(hasta)}</b></span>
                        </div>`;
            
            const randomFrase = (tipo) => {
                const frases = AppConfig.frasesNarrativas[tipo] || [];
                return frases.length ? frases[Math.floor(Math.random() * frases.length)] : "";
            };

            html += `<p class="lead">${randomFrase('apertura')}</p><hr/>`;

            if (resumen.ucrif && Object.values(resumen.ucrif).some(v => Array.isArray(v) ? v.length > 0 : v > 0)) html += this.renderizarUcrif(resumen.ucrif);
            if (resumen.grupo1 && Object.values(resumen.grupo1).some(v => v.length > 0)) html += this.renderizarGrupo1(resumen.grupo1);
            if (resumen.puerto && (Object.keys(resumen.puerto.numericos).length > 0 || resumen.puerto.ferrys.length > 0)) html += this.renderizarPuerto(resumen.puerto);
            if (resumen.cecorex && Object.keys(resumen.cecorex).length > 0) html += this.renderizarCecorex(resumen.cecorex);
            if (resumen.gestion && Object.keys(resumen.gestion).length > 0) html += this.renderizarGestion(resumen.gestion);
            if (resumen.cie && Object.keys(resumen.cie).length > 0) html += this.renderizarCIE(resumen.cie);

            html += `<hr/><p class="text-muted fst-italic mt-4">${randomFrase('cierre')}</p>`;
            return html;
        },

        renderizarUcrif(data) {
            const cfg = AppConfig.grupos.ucrif;
            let html = `<div class="card border-${cfg.theme} mb-4 shadow-sm">
                            <div class="card-header bg-${cfg.theme} text-white"><h4>${cfg.icon} ${cfg.label}</h4></div>
                            <div class="card-body p-4">`;

            let frase = `En el periodo se han efectuado <strong>${data.detenidosILE || 0}</strong> detenciones por Infracci√≥n a la Ley de Extranjer√≠a, se ha procedido a la filiaci√≥n de <strong>${data.filiadosVarios || 0}</strong> personas en diversos controles, se han materializado <strong>${data.traslados || 0}</strong> traslados y se ha citado a <strong>${data.citadosCecorex || 0}</strong> individuos para tr√°mites en CECOREX.`;
            html += `<p class="mb-4">${frase}</p>`;

            html += this.renderListSection('Inspecciones y Controles', data.inspecciones, i => this.formatters.inspeccion(i));
            html += this.renderListSection('Dispositivos Operativos Especiales', data.dispositivos, d => this.formatters.dispositivo(d));
            html += this.renderListSection('Detenidos por otros delitos', data.detenidosDelito, d => `${d.descripcion} por <strong>${d.motivo}</strong>`);
            
            if (data.observaciones && data.observaciones.filter(o => o && o.trim()).length > 0) {
                html += `<div class="alert alert-light mt-3"><strong>Observaciones Relevantes de los Grupos:</strong><br>${data.observaciones.filter(o => o && o.trim()).map(o => `<div><small>- ${o}</small></div>`).join("")}</div>`;
            }
            
            html += `</div></div>`;
            return html;
        },

        renderizarGrupo1(data) {
            const cfg = AppConfig.grupos.grupo1;
            let html = `<div class="card border-${cfg.theme} mb-4 shadow-sm">
                            <div class="card-header bg-${cfg.theme} text-white"><h4>${cfg.icon} ${cfg.label}</h4></div>
                            <div class="card-body p-4">`;
            
            html += this.renderListSection('Detenidos', data.detenidos, d => {
                const det = this.normalizers.detenido(d);
                return `<strong>${det.nombre}</strong> (${det.nacionalidad}) por <strong>${det.motivo}</strong>. ${det.diligencias ? `Diligencias: ${det.diligencias}`:''}`;
            });
            html += this.renderListSection('Expulsiones Materializadas', data.expulsados, e => `<strong>${this.normalizers.expulsado(e).nombre}</strong> (${this.normalizers.expulsado(e).nacionalidad}).`);
            html += this.renderListSection('Expulsiones Frustradas', data.frustradas, f => {
                const fru = this.normalizers.frustrada(f);
                return `<strong>${fru.nombre}</strong> (${fru.nacionalidad}) - Motivo: <strong>${fru.motivo}</strong>`;
            });
            html += this.renderListSection('Vuelos Fletados', data.fletados, f => `Destino: <strong>${this.normalizers.fletado(f).destino}</strong> - ${this.normalizers.fletado(f).pax} PAX.`);

            html += `</div></div>`;
            return html;
        },
        
        renderizarPuerto(data) {
            const cfg = AppConfig.grupos.puerto;
            let html = `<div class="card border-${cfg.theme} mb-4 shadow-sm">
                            <div class="card-header bg-${cfg.theme} text-white"><h4>${cfg.icon} ${cfg.label}</h4></div>
                            <div class="card-body p-4">`;

            // Secci√≥n de totales num√©ricos en columnas
            html += `<h5 class="mb-3 fw-bold text-primary-emphasis">Resumen de Actividad</h5><div class="row g-3">`;
            const fields = Object.entries(data.numericos);
             if (fields.length === 0) {
                html += `<div class="col-12"><p class="text-muted">Sin totales num√©ricos que mostrar.</p></div>`;
            } else {
                fields.forEach(([key, value]) => {
                    html += `<div class="col-sm-6 col-md-4">
                                <div class="d-flex justify-content-between align-items-center border rounded p-2 h-100 bg-light">
                                    <span class="text-capitalize small me-2">${key.replace(/_/g, " ").toLowerCase()}</span>
                                    <span class="badge bg-${cfg.theme} text-white rounded-pill fs-6">${value}</span>
                                </div>
                            </div>`;
                });
            }
            html += `</div>`;
            
            // Secci√≥n de listas
            html += this.renderListSection('Ferrys Controlados', data.ferrys, f => {
                const ferry = this.normalizers.ferry(f);
                return `<strong>${ferry.destino}</strong> - Pasajeros: ${ferry.pasajeros || 0}, Veh√≠culos: ${ferry.vehiculos || 0}. ${ferry.incidencias ? `<strong class="text-danger">Incidencia: ${ferry.incidencias}</strong>` : ''}`;
            });
            html += this.renderListSection('Gestiones Realizadas', data.gestiones, g => g.gestion);

            html += `</div></div>`;
            return html;
        },

        renderizarCecorex(data) {
            const cfg = AppConfig.grupos.cecorex;
            let html = `<div class="card border-warning mb-4 shadow-sm">
                            <div class="card-header bg-warning text-dark"><h4>${cfg.icon} ${cfg.label}</h4></div>
                            <div class="card-body p-4"><div class="row g-3">`;

            const fields = Object.entries(data);
            if (fields.length === 0) {
                html += `<div class="col-12"><p class="text-muted">No hay datos para mostrar en este periodo.</p></div>`;
            } else {
                fields.forEach(([key, value]) => {
                    html += `
                        <div class="col-sm-6 col-md-4">
                            <div class="d-flex justify-content-between align-items-center border rounded p-2 h-100 bg-light">
                                <span class="text-capitalize small me-2">${key.replace(/_/g, " ").toLowerCase()}</span>
                                <span class="badge bg-warning text-dark rounded-pill fs-6">${value}</span>
                            </div>
                        </div>`;
                });
            }

            html += `</div></div></div>`;
            return html;
        },
        
        renderizarGestion(data) { return this.renderKeyValueCard(AppConfig.grupos.gestion, data); },
        renderizarCIE(data) { return this.renderKeyValueCard(AppConfig.grupos.cie, data); },

        renderKeyValueCard(cfg, data) {
            let html = `<div class="card border-${cfg.theme} mb-4 shadow-sm">
                            <div class="card-header bg-${cfg.theme} text-white"><h4>${cfg.icon} ${cfg.label}</h4></div>
                            <div class="card-body p-3"><ul class="list-group list-group-flush">`;
            
            Object.entries(data).forEach(([key, value]) => {
                html += `<li class="list-group-item d-flex justify-content-between align-items-center text-capitalize">
                            ${key.replace(/_/g, " ")}
                            <span class="badge bg-${cfg.theme} rounded-pill fs-6">${value}</span>
                        </li>`;
            });
            
            html += `</ul></div></div>`;
            return html;
        },
        
        renderListSection(title, data, formatter) {
            if (!data || data.length === 0) return '';
            let html = `<h5 class="mt-4 mb-2 fw-bold text-primary-emphasis" style="font-size: 1.1rem;">${title} (${data.length})</h5><ul class="list-group list-group-flush">`;
            data.forEach(item => { html += `<li class="list-group-item">${formatter(item)}</li>`; });
            html += `</ul>`;
            return html;
        },

        formatoFecha: (fechaStr) => fechaStr ? fechaStr.split('-').reverse().join('/') : "N/A",

        formatters: {
            dispositivo: (d) => (typeof d === "string") ? d : `${d.descripcion || ''} ${d.operacion ? `(Op. ${d.operacion})` : ''}`.trim() || "[Dispositivo operativo]",
            inspeccion: (i) => (typeof i === "string") ? i : `<strong>${i.lugar || 'Lugar N/D'}</strong> (${i.tipo || 'Tipo N/D'}) ‚Äî ${i.resultado || 'Sin resultado'}`,
        },
        normalizers: {
            detenido: (obj) => ({ nombre: obj.detenidos_g1 || "N/A", motivo: obj.motivo_g1 || "N/A", nacionalidad: obj.nacionalidad_g1 || "N/A", diligencias: obj.diligencias_g1 || "" }),
            expulsado: (obj) => ({ nombre: obj.expulsados_g1 || "N/A", nacionalidad: obj.nacionalidad_eg1 || "N/A" }),
            fletado: (obj) => ({ destino: obj.destino_flg1 || "N/A", pax: obj.pax_flg1 || 0 }),
            frustrada: (obj) => ({ nombre: obj.exp_frustradas_g1 || "N/A", nacionalidad: obj.nacionalidad_fg1 || "N/A", motivo: obj.motivo_fg1 || "N/A" }),
            ferry: (obj) => ({ destino: obj.destino || "N/D", pasajeros: obj.pasajeros || 0, vehiculos: obj.vehiculos || 0, incidencias: obj.incidencias || "" })
        }
    };

    // --- 7. L√ìGICA DE EXPORTACI√ìN (ExportManager) ---
    const ExportManager = {
        generarTextoWhatsapp(resumen, desde, hasta) {
            const f = UIRenderer.formatoFecha;
            let out = `*üõ°Ô∏è SIREX - RESUMEN OPERATIVO*\n*Periodo:* ${f(desde)} al ${f(hasta)}\n`;
            const addSection = (cfg, content) => { if (content && content.trim()) out += `\n*${cfg.icon} ${cfg.label.toUpperCase()}*\n${content}`; };

            if (resumen.ucrif) {
                const u = resumen.ucrif;
                let content = `‚Ä¢ *Totales*: ${u.detenidosILE || 0} ILE, ${u.filiadosVarios || 0} filiados, ${u.traslados || 0} traslados.\n`;
                if (u.inspecciones?.length > 0) content += `‚Ä¢ Inspecciones: ${u.inspecciones.length}\n`;
                if (u.detenidosDelito?.length > 0) content += `‚Ä¢ Detenidos (delito): ${u.detenidosDelito.length}\n`;
                addSection(AppConfig.grupos.ucrif, content);
            }
            if (resumen.grupo1) {
                const g1 = resumen.grupo1;
                let content = '';
                if(g1.detenidos?.length > 0) content += `‚Ä¢ Detenidos: ${g1.detenidos.length}\n`;
                if(g1.expulsados?.length > 0) content += `‚Ä¢ Expulsados: ${g1.expulsados.length}\n`;
                if(g1.frustradas?.length > 0) content += `‚Ä¢ Frustradas: ${g1.frustradas.length}\n`;
                addSection(AppConfig.grupos.grupo1, content);
            }
             if (resumen.puerto?.numericos) {
                addSection(AppConfig.grupos.puerto, `‚Ä¢ Pasajeros Chequeados: ${resumen.puerto.numericos.paxChequeadas || 0}\n‚Ä¢ Veh√≠culos Chequeados: ${resumen.puerto.numericos.vehChequeados || 0}\n‚Ä¢ Denegaciones: ${resumen.puerto.numericos.denegaciones || 0}`);
            }
            const addKeyValueSection = (cfg, data) => { if (data && Object.keys(data).length > 0) addSection(cfg, Object.entries(data).map(([k,v]) => `‚Ä¢ ${k.replace(/_/g, " ")}: ${v}`).join('\n')); };
            addKeyValueSection(AppConfig.grupos.cecorex, resumen.cecorex);
            addKeyValueSection(AppConfig.grupos.gestion, resumen.gestion);
            addKeyValueSection(AppConfig.grupos.cie, resumen.cie);
            out += `\n_Parte cerrado y generado autom√°ticamente por SIREX._`;
            return out;
        },

        exportarPDF(resumen, desde, hasta) {
            if (typeof window.jspdf.jsPDF.API.autoTable !== 'function') {
                alert("Error al generar PDF: El plugin de tablas no est√° disponible."); return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            let finalY = 15;
            const pageW = doc.internal.pageSize.getWidth();
            const margin = 15;
            const randomFrase = (tipo) => AppConfig.frasesNarrativas[tipo][Math.floor(Math.random() * AppConfig.frasesNarrativas[tipo].length)];

            // --- Header & Footer ---
            const addHeader = () => {
                doc.setFont("helvetica", "bold"); doc.setFontSize(16);
                doc.text("SIREX - Resumen Operativo Global", pageW / 2, finalY, { align: "center" });
                finalY += 8;
                doc.setFont("helvetica", "normal"); doc.setFontSize(11);
                doc.text(`Periodo: ${UIRenderer.formatoFecha(desde)} al ${UIRenderer.formatoFecha(hasta)}`, pageW / 2, finalY, { align: "center" });
                finalY += 10;
            };
            const addFooter = () => {
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i); doc.setFontSize(8); doc.setTextColor(150);
                    doc.text(`P√°gina ${i} de ${pageCount}`, pageW / 2, 287, { align: 'center' });
                    doc.text(`Informe generado el ${new Date().toLocaleString('es-ES')} por SIREX`, margin, 287);
                }
            };
             const checkPageBreak = () => { if (finalY > 250) { doc.addPage(); finalY = 20; } };

            // --- Content ---
            addHeader();
            doc.setFontSize(10);
            const introText = doc.splitTextToSize(randomFrase('apertura'), pageW - margin * 2);
            doc.text(introText, margin, finalY);
            finalY += introText.length * 4 + 5;

            const addSection = (cfg, callback) => {
                checkPageBreak();
                doc.setFontSize(12); doc.setFont("helvetica", "bold"); doc.setTextColor(cfg.color);
                doc.text(`${cfg.icon} ${cfg.label}`, margin, finalY);
                finalY += 6;
                doc.setFontSize(10); doc.setFont("helvetica", "normal"); doc.setTextColor(0, 0, 0);
                callback();
                finalY += 5;
            };

            const autoTable = (head, body, cfg) => {
                doc.autoTable({
                    startY: finalY, head: head, body: body, theme: 'striped',
                    headStyles: { fillColor: cfg.color, textColor: '#FFFFFF' },
                    didDrawPage: () => finalY = 20 // Reset Y on new page
                });
                finalY = doc.autoTable.previous.finalY;
            };

            // UCRIF
            if (resumen.ucrif) addSection(AppConfig.grupos.ucrif, () => {
                autoTable(null, [
                    ['Detenidos por ILE', resumen.ucrif.detenidosILE || 0],
                    ['Personas Filiadas', resumen.ucrif.filiadosVarios || 0],
                    ['Traslados Realizados', resumen.ucrif.traslados || 0],
                ], AppConfig.grupos.ucrif);
                if (resumen.ucrif.detenidosDelito?.length > 0) {
                    finalY += 3;
                    autoTable([['Detenidos por Delito Com√∫n', 'Motivo']], resumen.ucrif.detenidosDelito.map(d => [d.descripcion, d.motivo]), AppConfig.grupos.ucrif);
                }
            });

            // GRUPO 1
            if (resumen.grupo1) addSection(AppConfig.grupos.grupo1, () => {
                if (resumen.grupo1.expulsados?.length > 0) autoTable([['Expulsiones Materializadas', 'Nacionalidad']], resumen.grupo1.expulsados.map(e => [UIRenderer.normalizers.expulsado(e).nombre, UIRenderer.normalizers.expulsado(e).nacionalidad]), AppConfig.grupos.grupo1);
                if (resumen.grupo1.frustradas?.length > 0) { finalY += 2; autoTable([['Expulsiones Frustradas', 'Motivo']], resumen.grupo1.frustradas.map(f => [UIRenderer.normalizers.frustrada(f).nombre, UIRenderer.normalizers.frustrada(f).motivo]), AppConfig.grupos.grupo1); }
            });

            // PUERTO, CECOREX, GESTION, CIE (Key-Value)
            const addKeyValueSectionToPdf = (cfg, data) => {
                if(data && Object.keys(data).length > 0) {
                    addSection(cfg, () => autoTable(null, Object.entries(data).map(([k,v]) => [k.replace(/_/g, " "), v]), cfg));
                }
            };
            addKeyValueSectionToPdf(AppConfig.grupos.puerto, resumen.puerto?.numericos);
            addKeyValueSectionToPdf(AppConfig.grupos.cecorex, resumen.cecorex);
            addKeyValueSectionToPdf(AppConfig.grupos.gestion, resumen.gestion);
            addKeyValueSectionToPdf(AppConfig.grupos.cie, resumen.cie);

            checkPageBreak();
            finalY += 5;
            doc.setFont("helvetica", "italic");
            const outroText = doc.splitTextToSize(randomFrase('cierre'), pageW - margin * 2);
            doc.text(outroText, margin, finalY);

            addFooter();
            doc.save(`SIREX_Resumen_${desde}_a_${hasta}.pdf`);
        }
    };

    // --- 8. MANEJADOR PRINCIPAL DE EVENTOS ---
    async function handleFormSubmit(e) {
        e.preventDefault();
        DOM.resumenVentana.innerHTML = '';
        DOM.spinner.classList.remove('d-none');
        DOM.exportBtns.classList.add('d-none');

        const desde = DOM.fechaDesde.value;
        const hasta = DOM.fechaHasta.value;

        if (!desde || !hasta || desde > hasta) {
            DOM.resumenVentana.innerHTML = `<div class="alert alert-danger">Por favor, selecciona un rango de fechas v√°lido. La fecha "Desde" no puede ser posterior a "Hasta".</div>`;
            DOM.spinner.classList.add('d-none');
            return;
        }
        
        try {
            const promesas = {
                ucrif: QueryManager.getUcrifNovedades(desde, hasta),
                grupo1: QueryManager.getGrupo1Detalles(desde, hasta),
                puerto: QueryManager.getPuertoDetalles(desde, hasta),
                cecorex: QueryManager.sumarCampos('cecorex_registros', desde, hasta),
                gestion: QueryManager.sumarCampos('gestion_registros', desde, hasta),
                cie: QueryManager.getCIE(desde, hasta),
            };

            const resultados = await Promise.all(Object.values(promesas));
            const resumen = Object.keys(promesas).reduce((acc, key, index) => {
                acc[key] = resultados[index];
                return acc;
            }, {});
            
            appState = { ultimoResumen: resumen, desde, hasta };
            DOM.resumenVentana.innerHTML = UIRenderer.renderizarResumenGlobalHTML(resumen, desde, hasta);
            DOM.exportBtns.classList.remove('d-none');
        } catch (err) {
            console.error("Error al generar resumen:", err);
            DOM.resumenVentana.innerHTML = `<div class="alert alert-danger"><strong>Error al consultar los datos:</strong> ${err.message}. Revisa la consola para m√°s detalles.</div>`;
        } finally {
            DOM.spinner.classList.add('d-none');
        }
    }

    // --- 9. ASIGNACI√ìN DE EVENTOS ---
    DOM.form.addEventListener('submit', handleFormSubmit);
    DOM.btnWhatsapp.addEventListener('click', () => appState.ultimoResumen && window.open(`https://wa.me/?text=${encodeURIComponent(ExportManager.generarTextoWhatsapp(appState.ultimoResumen, appState.desde, appState.hasta))}`, '_blank'));
    DOM.btnExportarPDF.addEventListener('click', () => appState.ultimoResumen && ExportManager.exportarPDF(appState.ultimoResumen, appState.desde, appState.hasta));

    // --- INICIALIZACI√ìN ---
    const today = new Date().toISOString().split('T')[0];
    DOM.fechaDesde.value = today;
    DOM.fechaHasta.value = today;
});
